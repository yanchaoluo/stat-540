---
title: "Assignment 1"
author: "Yanchao"
date: '2019-02-26'
output: github_document
---

```{r}
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(reshape2))
suppressPackageStartupMessages(library(limma))
suppressPackageStartupMessages(library(knitr))
suppressPackageStartupMessages(library(pheatmap))
```

## Question 1: Data Inspection and Basic Manipulation

### Q1.1 Importing the data and getting familiar with it (1 POINT)

- **Read the datasets into R-Studio.**
```{r}
data <- readRDS(file = 'gse60019_expression_matrix.RDS')

meta_data <- readRDS(file = 'gse60019_experiment_design.RDS')
```

- **How many genes are there?**
```{r}
nrow(data)
```

There are 14479 genes.

- **How many samples are there?**
```{r}
ncol(data)-1
length(meta_data$sample)
```
There are 18 samples.

- **How many factors are in our experimental design? How may levels per factor? List out the levels for each factor.**
```{r}
str(meta_data)
```

There are 4 factors, which are organism_part, cell_type, time_point and batch.
There are 2 levels for organism_part, 2 levels for cell_type, 4 levels for time_points, and 3 levels for batch.

*2 levels for organism_part:*
```{r}
levels(meta_data$organism_part) 
```

*2 levels for cell_type*
```{r}
levels(meta_data$cell_type) 
```

*4 levels for time_points*
```{r}
levels(meta_data$time_point) 
```

*3 levels for batch*
```{r}
levels(meta_data$batch) 
```

### Q1.2 Data manipulation (2 POINTS)

The levels of the factor `time_point` actually refer to points on a continous axis. In other words, it doesn't have to be interpreted as strictly categorical variable. In order to make graphing easier, it will be helpful to convert this variable to a numeric representation.

- **Create a new column in the samples metadata tibble. Call it "age" and populate it with the appropriate numeric values. Hint: Assume that the mouse gestation length is 18 days (ie. P0 = 18).  **
```{r}

meta_data$age <- ifelse(meta_data$time_point == "E16", 16, ifelse(meta_data$time_point == "P0", 18, ifelse(meta_data$time_point == "P4", 22, ifelse(meta_data$time_point == "P7", 25, 0))))
  
```

### Q1.3 Single gene graphing (2 POINTS)

- **Find the expression profile for the gene Vegfa. Make a scatterplot with age on the x-axis and expression value in CPM on the y-axis. Color the data points by cell_type. Add in a regression line for each cell type.**
```{r}
geneIds<- "Vegfa"
vegfa <- data %>% filter(gene %in% geneIds)
# transform the data frame into the format that matches the sample metadata
vegfa <- vegfa %>%
  as.data.frame() %>% 
  column_to_rownames("gene") %>%
  t() %>% as.data.frame() %>% 
  rownames_to_column("sample") %>% 
  melt(id = "sample") %>% 
  as_tibble() %>% 
  select(sample,
         gene = variable, 
         expression = value)

head(vegfa)

```
The left_join() function ensures that all rows in the first data frame are retained while unmatched rows in the second data frame are dropped.
```{r}
vegfa_data<-vegfa %>%  left_join(meta_data, by = "sample")

vegfa_data %>%  ggplot(aes(x= age, y= expression, color= cell_type)) +
    geom_point()+
    geom_smooth(method="lm", se = FALSE) +
    ggtitle("Vegfa Gene scatterplot of age vs expression value") +
    labs(x = 'age', y = 'expression levels (CPM)', color = 'Cell Type') +
    theme(plot.title = element_text(hjust = 0.5))+
  theme_bw()
```

- **Is there sign of interaction between cell_type and age for Vegfa? Explain using what you observed in your graph from the previous question.**

There is no interaction between cell_type and age for Vegfa because both lines of two types have similar slope(the two regression lines are approximately parallel with each other).

## Question 2: Assessing overall data quality

### Q2.1 Overall distributions (2 POINTS)

- **The expression values are currently in CPM. Log2 transform them so that the distribution is more evenly spread out and can be examined more easily.**
```{r}

log_data <- log2(data[ ,2:19])
log_data$gene <- data$gene
```

- **Examine the distribution of gene expression across all samples using 1. box plots and 2. overlapping density plots.**
    - For the box plots, samples should be on the x-axis and expression should be on the y-axis.
    - For the overlapping density plots, expression should be on the x-axis and density should be on the y-axis. Lines should be colored by sample (i.e. one line per sample).
    - Hint: There are a number of data manipulation steps required. Look at the melt() function in reshape2.
    
*box plot*

```{r}
melted_data <- melt(log_data, id.vars = "gene", var = "Sample")
head(melted_data)
melted_data %>% ggplot(aes(x=Sample, y= value, fill = Sample) )+
  geom_boxplot()+
  theme_bw()
```

*density plots*
```{r}
melted_data %>% ggplot(aes(x=value, color = Sample) )+
 geom_density()+
  theme_bw()
```

- **Which two samples stand out as different, in terms of the distribution of expression values, compared to the rest?**

GSM1463880 and GSM1463879 stand out as different. They have the largest IQR in the box plots and their densities have the highest peak in the density plot compared to the rest.

## Q2.2 How do the samples correlate with one another? (2 POINTS) 

- **Examine the correlation between samples using one or more heatmaps (i.e. samples should be on the x axis and the y axis, and the values in the heatmap should be correlations). Again, use the log2 transformed expression values. Display cell_type, organism_part, age, and batch for each sample in the heatmap. Hint: Consider using pheatmap() with annotations and cor to correlate gene expression between each pair of samples.**


```{r,fig.width=18, fig.height=10}
data_log_corr <- cor(log_data[,1:18], method=c("pearson")) #Create correlation matrix of samples
annotation1= as.data.frame(meta_data[, c( "cell_type", "organism_part", "age", "batch")]) #  # Set matrix to annotate clusters
rownames(annotation1) <- colnames(data[,2:19]) 
# set pheatmap clustering parameters
clust_dist_col = "euclidean"  #‘'correlation'’ for Pearson correlation, ‘'euclidean'’, ‘'maximum'’, ‘'manhattan'’, ‘'canberra'’, ‘'binary'’ or ‘'minkowski'’
clust_method = "complete"  #‘'ward.D'’, ‘'ward.D2'’,‘'single'’, ‘'complete'’, ‘'average'’ (= UPGMA), ‘'mcquitty'’ (= WPGMA), ‘'median'’ (= WPGMC) or ‘'centroid'’ (= UPGMC)
clust_scale = "none"  #'column', 'none', 'row'


#Heatmap to see sample correlations
pheatmap(data_log_corr, scale = clust_scale, cluster_rows = TRUE, cluster_cols = TRUE, clustering_method = clust_method, 
    clustering_distance_cols = clust_dist_col, show_colnames = T, show_rownames = FALSE, 
    main = "gene expression between each pair of samples.", annotation = annotation1)
```

- **Among the factors cell_type, organism_part, age, and batch, which one seems to be most strongly correlated with clusters in gene expression data? Hint: Consider using 'cluster_rows=TRUE' in pheatmap().**
Cell type seems to be most strongly correlated with clusters in gene expression data among the factors cell_type, organism_part, age. If we set the number of clusters to be 2, then the two clusters are seperated by cell type.

- **There is a sample whose expression values correlate with the samples of the different cell_type just as well as with the samples of the same cell_type. Identify this sample by its ID.**

The sample ID is GSM1463872.

## Question 3: Using PCA to dig deeper

### Q3.1 Perform PCA to summarize the samples. (2 POINTS)

- **Perform PCA. Hint: Use svd() or prcomp() and remember to scale and center the expression data for all genes by using scale() and t(). Make sure to turn off scaling and centering in prcomp()!**
```{r}
scale_log_data <- t(scale(t(data[,2:19]))) # scale the data 
pcs <- prcomp(scale_log_data, center = FALSE, scale = FALSE)
```

- **Make a bar graph showing the amount of variance explained by each PC, where variance explained is on the y axis and each PC is on the x axis**
```{r}
# scree plot
barplot(pcs$sdev^2,xlab = 'Principal Components', ylab = ' Variance',xlim = c(0, 20))
```
## Q3.2 Confirm your suspicion. Is cell_type the biggest contributor to variation? (2 POINTS)

- **Which PCs seem to be associated with the cell_type variable? Make scatterplots with celltype on the x axis and a particular PC on the y-axis for PCs 1-3 and  take your best guess based on a visual assessment.**
```{r}
# append the rotations for the first 10 PCs to the data
prinComp <- cbind(meta_data, pcs$rotation[meta_data$sample, 1:10])

# scatter plot showing us how the first few PCs relate to covariates
plot(prinComp[, c("cell_type", "PC1", "PC2", "PC3")], pch = 19, cex = 0.8)
```

PC1 seem to be associated with the cell_type variable based on a visual assessment.

## Q3.3 Characterizing batch effects. (2 POINTS)

- **Quantitatively assess the association of the batch variable with each PC up to PC10. Hint: Fit a linear model and look at the coefficient of determination (R-Squared)**

```{r}
R_squared <- c()
for (i in 1:10){
  R_squared[i] <- summary(lm(prinComp[,(6+i)]~prinComp$batch))$r.squared
}

PC<-c("PC1","PC2","PC3","PC4","PC5","PC6","PC7","PC8","PC9","PC10")
c_r_squared<-as.data.frame(cbind(PC,R_squared))
c_r_squared
```

- **How much of the variation in PC2 is explained by batch effects? How does that compare with PC1? Hint: Remember the definition of R-squared.**
```{r}
ggplot(c_r_squared, aes(x = PC, y = R_squared, fill = as.factor(R_squared)))  + geom_bar(stat = 'identity') + 
         labs(y = 'R Squared (R^2)') +
  ggtitle('Association between Batch and Principal Components') + 
  theme_bw()
```

R squared is the proportion of the variance in the PC that is predictable from the batch. Around 31.38% in the PC2 is predictable from the bacth, whilst only 13.15% of variance in PC1 is predictable from batch. PC2 seems to explain approximate 2.39 times variance in the data from the batch effect compared to PC1.
